<!DOCTYPE html>
<html>
    <head>
        <title>计时器</title>
        <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
        <style>
            *{
                font-size: xx-large;
            }
            body{
                width: 100%;
                height: 100%;
            }
            .bg{
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
            }
            #timer{
                position: absolute;
                left: 50%;
                top:50%;
                transform: translate(-50%,-50%);
                text-align: center;
            }
            .timer-number{
                text-align: center;
            }
            .control{
                position: absolute;
                bottom: 2%;
                right: 2%;
            }
            .control-item{
                float: left;
            }
            small{
                font-size:medium;
            }
        </style>
    </head>
    <body>
        <div id="bg" class="bg"></div>
        <div id="timer">
            <p id="cat"><!--small>学习</small><span>工作</span><small>娱乐</small--></p>
            <p id="time" class="timer-number">123</p>
        </div>
        <div class="control">
            <div class="control-item"><button class="">管理分类</button></div>
            <div class="control-item"><button class="">查看统计</button></div>
        </div>
    </body>
    <script>
        var mtime=0
        var current=""
        $(document).ready(()=>{
            let cate=getCategory()
            let data=getData()
            if (data.length>0){
                let last=data[data.length-1]
                current=last.name
                t=last.total
            }else{
                current=cate[0]
            }
            changeCurrent(data,cate,current)

            setInterval(()=>{
                mtime++
                $("#time").text(timeParse(mtime))
            },100)
            setInterval(()=>{
                saveData(data)
            },1000)
            let hammer=new Hammer(document.getElementById("bg"))
            hammer.on("swipeleft",(e)=>{
                next(data,cate)
            })
            hammer.on("swiperight",(e)=>{
                prev(data,cate)
            })
        })
        function prev(data,cate){
            cu=0
            for(i=0;i<cate.length;i++){
                if (cate[i]==current){
                    cu=i
                }
            }
            cu--
            if(cu==0){
                cu=cate.length-1
            }
            current=cate[cu]
            changeCurrent(data,cate,current)
        }
        function next(data,cate){
            cu=0
            for(i=0;i<cate.length;i++){
                if (cate[i]==current){
                    cu=i
                    break
                }
            }
            cu++
            if(cu==cate.length){
                cu=0
            }
            current=cate[cu]
            changeCurrent(data,cate,current)
        }
        function changeCurrent(data,cate,current){
            html=buildCate(cate,current)
            $("#cat").html(html)
            stat=statistc(data)
            if (typeof stat[current]!=="undefined"){
                mtime = Math.floor(stat[current]/100)
            }
        }
        function buildCate(list,current){
            ct=list.length
            half=Math.floor((ct-1)/2)
            cu=half
            for(i=0;i<ct;i++){
                if (list[i]==current){
                    cu=i
                }
            }
            left_start=0
            left_end=cu-1
            if (left_end==-1){
                left_end=ct-1
            }
            right_start=cu+1
            if (right_start==ct){
                right_start=0
            }
            right_end=ct-1
            if (cu<half){
                left_start=ct-(half-cu)
                right_end=left_start-1
            }else if (cu>half){
                right_end=cu-half-1
                left_start=right_end+1
            }
            i=left_start
            html=""
            while(true){
                html+="<small>"+list[i]+"<small>&nbsp;"
                if (i==left_end){
                    break
                }
                i++
                if (i==ct){
                    i=0
                }
            }
            html+="<span>"+list[cu]+"<span>"
            i=right_start
            while(true){
                html+="<small>"+list[i]+"</samll>&nbsp;"
                if (i==right_end){
                    break
                }
                i++
                if (i==ct){
                    i=0
                }
            }
            return html
        }
        function statistc(data){
            result={}
            for(i=0;i<data.length;i++){
                if (typeof result[data[i].name]==="undefined"){
                    result[data[i].name]=0
                }
                duration=data[i].time.end-data[i].time.start
                result[data[i].name]+=duration
            }
            return result
        }
        function timeParse(t){
            let h=Math.floor(t/36000)
            t=t%36000
            let m=Math.floor(t/600)
            t=t%600
            let s=Math.floor(t/10)
            t=t%10
            let txt=""
            if (h>0){
                txt+=h+"h "
            }
            if (m>0){
                txt+=m+"m "
            }
            txt+=s+"."+t+"s"
            return txt
        }
        function saveData(data){
            time=(new Date()).valueOf()
            last=data[data.length-1]
            if (last!=undefined && last.name==current && time-last.time.end<2000){
                last.time.end=time
            }else{
                data.push({
                    name:current,
                    time:{
                        start:time,
                        end:time,
                    }
                })
            }
            setData(data)
        }
        function getCategory(){
            let cate=localStorage.getItem("category")
            if (cate==null){
                return [
                    "工作",
                    "学习",
                    "娱乐",
                ]
            }
            return cate
        }
        function getData(){
            let d=localStorage.getItem("timer")
            if (d==null){
                return [
                    // {
                    //     "name":"工作",
                    //     "time":{
                    //         "start":0,
                    //         "end":0,
                    //     },
                    // }
                ]
            }
            return JSON.parse(d)      
        }
        function setData(data){
            localStorage.setItem("timer",JSON.stringify(data))
        }
    </script>
</html>